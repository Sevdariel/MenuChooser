<form [formGroup]="formGroup" (ngSubmit)="onSubmit()" class="step-form pt-2">
  <p-floatLabel variant="on">
    <p-inputNumber
      id="order"
      [showButtons]="true"
      [min]="1"
      formControlName="order"
      class="w-full"
    ></p-inputNumber>
    <label for="order">Step Number</label>
  </p-floatLabel>

  <p-floatLabel variant="on">
    <textarea
      pTextarea
      id="content"
      formControlName="content"
      rows="5"
      [autoResize]="true"
      class="w-full"
    ></textarea>
    <label for="content">Instructions</label>
  </p-floatLabel>

  <p-floatLabel variant="on">
    <p-inputNumber
      id="duration"
      formControlName="duration"
      mode="decimal"
      [showButtons]="true"
      class="w-full"
    ></p-inputNumber>
    <label for="duration">Duration (minutes)</label>
  </p-floatLabel>

  <p-floatLabel variant="on">
    <p-multiSelect
      [options]="availableProducts()"
      name="products"
      optionLabel="product.name"
      [formControl]="selectedProductsFormControl"
      class="w-full"
      [showToggleAll]="false"
      [filter]="true"
      filterBy="product.name"
      [showHeader]="false"
      [selectionLimit]="availableProducts.length"
      [panelStyle]="{ 'max-height': '200px' }"
    >
      <ng-template let-product pTemplate="item">
        <div class="product-item">
          <div>{{ product.product.name }}</div>
          <!-- <div class="product-quantity">{{ product.quantity }} {{ product.product.unit }}</div> -->
        </div>
      </ng-template>
    </p-multiSelect>
    <label>Products Used in This Step</label>
  </p-floatLabel>

  @if (selectedProducts() && selectedProducts()!.length > 0) {
    <p-table [value]="productsArray.controls">
      <ng-template pTemplate="header">
        <tr>
          <th>Product</th>
          <th>Quantity</th>
          <th>Unit</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-row let-rowIndex="rowIndex">
        <tr [formGroup]="row">
          <td>
            {{ row.get("product").value.name }}
          </td>

          <td pEditableColumn>
            <p-cellEditor>
              <ng-template pTemplate="input">
                <p-inputNumber formControlName="quantity" fluid>
                </p-inputNumber>
              </ng-template>

              <ng-template pTemplate="output">
                {{ row.value.quantity }}
              </ng-template>
            </p-cellEditor>
          </td>

          <td pEditableColumn>
            <p-cellEditor>
              <ng-template pTemplate="input">
                <p-select
                  formControlName="unit"
                  [options]="units"
                  optionLabel="name"
                  appendTo="body"
                >
                </p-select>
              </ng-template>
              <ng-template pTemplate="output">
                {{ row.value.unit }}
              </ng-template>
            </p-cellEditor>
          </td>
        </tr>
      </ng-template>
    </p-table>
  }

  <div class="form-actions">
    <button
      pButton
      type="button"
      label="Cancel"
      icon="pi pi-times"
      class="p-button-text"
      (click)="closeDrawer.emit()"
    ></button>
    <button
      pButton
      type="submit"
      [label]="step()?.order !== null ? 'Update' : 'Add'"
      icon="pi pi-check"
      [disabled]="!formGroup.valid"
    ></button>
  </div>
</form>
